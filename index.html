<!DOCTYPE html>
<html>
<head>
<title>Nevsky Supply Calculator</title>
<meta charset="UTF-8">
</head>
<body>
    <p id="demo">Hello world</p>
    <script>
        const teuton_lords = ["Andreas", "Hermann", "Heinrich", "Knud&Abel", "Rudolf", "Yaroslav"]
        const russian_lords = ["Aleksandr", "Andrey", "Domash", "Gavrilo", "Vladislav", "Karelians"]
        const map = {
            "Warbola": { trackways: ["Reval", "Harrien", "Leal"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Reval" : { trackways: ["Warbola", "Revala"], waterways : [], teuton: true, seats: ["Knud&Abel"], commandery: false, stronghold: true, port: true},
            "Revala" : { trackways: ["Reval", "Wesenberg"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Wesenberg" : { trackways: ["Revala", "Jerwen", "Wierland"], waterways : [], teuton: true, seats: ["Knud&Abel"], commandery: false, stronghold: true, port: false},
            "Wierland" : { trackways: ["Wesenberg", "Narwia", "Waiga"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Narwia" : { trackways: ["Wierland", "Kaibolovo"], waterways : ["Dorpat", "Gdov", "Uzmen", "Plyussa River"], teuton: true, seats: [], commandery: false, stronghold: false, port: true},
            "Harrien" : { trackways: ["Warbola", "Jerwen"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Jerwen" : { trackways: ["Harrien", "Wesenberg"], waterways : ["Pernau", "Fellin"], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Waiga" : { trackways: ["Wierland", "Dorpat"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Leal" : { trackways: ["Warbola", "Pernau"], waterways : [], teuton: true, seats: ["Heinrich"], commandery: true, stronghold: true, port: true},
            "Pernau" : { trackways: ["Leal"], waterways : ["Jerwen", "Fellin"], teuton: true, seats: [], commandery: false, stronghold: false, port: true},
            "Fellin" : { trackways: [], waterways : ["Pernau", "Jerwen", "Dorpat", "Odenpah"], teuton: true, seats: [], commandery: true, stronghold: true, port: false},
            "Dorpat" : { trackways: ["Odenpah", "Ugaunia"], waterways : ["Fellin", "Odenpah", "Narwia", "Gdov", "Uzmen"], teuton: true, seats: ["Hermann"], commandery: false, stronghold: true, port: false},
            "Sackala" : { trackways: ["Fellin", "Metsepole"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Odenpah" : { trackways: ["Dorpat", "Ugaunia", "Kirrumpah"], waterways : ["Fellin", "Dorpat"], teuton: true, seats: ["Hermann", "Yaroslav"], commandery: false, stronghold: true, port: false},
            "Ugaunia" : { trackways: ["Dorpat", "Odenpah", "Uzmen", "Izborsk"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Metsepole" : { trackways: ["Sackala", "Wenden"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Kirrumpah" : { trackways: ["Odenpah", "Izborsk", "Adsel"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Wenden" : { trackways: ["Metsepole, Tolowa"], waterways : ["Riga", "Adsel"], teuton: true, seats: ["Andreas", "Rudolf"], commandery: true, stronghold: true, port: false},
            "Adsel" : { trackways: ["Kirrumpah", "Lettgallia", "Tolowa"], waterways : ["Wenden"], teuton: true, seats: [], commandery: true, stronghold: true, port: false},
            "Lettgalia" : { trackways: ["Adsel", "Tolowa", "Izborsk", "Rositten", "Ostrov"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Riga" : { trackways: [], waterways : ["Wenden"], teuton: true, seats: ["Andreas"], commandery: false, stronghold: true, port: true},
            "Tolowa" : { trackways: ["Wenden", "Adsel", "Lettgallia", "Rositten"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
            "Rositten" : { trackways: ["Tolowa", "Lettgallia"], waterways : [], teuton: true, seats: [], commandery: false, stronghold: false, port: false},
        
            "Karelia" : { trackways: ["Neva"], waterways : [], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Luga" : { trackways: [], waterways : ["Kaibolovo"], teuton: false, seats: [], commandery: false, stronghold: false, port: true},
            "Kaibolovo" : { trackways: ["Narwia", "Koporye"], waterways : ["Luga", "Zheltsy"], teuton: false, seats: [], commandery: false, stronghold: true, port: false},
            "Koporye" : { trackways: ["Kaibolovo", "Vod"], waterways : [], teuton: false, seats: [], commandery: false, stronghold: true, port: true},
            "Neva" : { trackways: ["Karelia", "Vod", "Izhora"], waterways : ["Ladoga"], teuton: false, seats: [], commandery: false, stronghold: false, port: true},
            "Ladoga" : { trackways: ["Izhora"], waterways : ["Neva", "Volkhov"], teuton: false, seats: ["Vladislav, Karelians"], commandery: false, stronghold: true, port: false},
            "Vod" : { trackways: ["Koporye", "Neva", "Ingria"], waterways : [], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Izhora" : { trackways: ["Neva", "Ladoga", "Ingria"], waterways : [], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Ingria" : { trackways: ["Vod", "Izhoria", "Tesovo"], waterways : [], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Volkhov" : { trackways: [], waterways : ["Ladoga", "Novgorod"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Gdov" : { trackways: ["Plyussa River"], waterways : ["Narwia", "Dorpat", "Uzmen"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Plyussa River" : { trackways: ["Gdov", "Zheltsy", "Zhelcha River"], waterways : ["Narwia"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Zheltsy" : { trackways: ["Plyussa River"], waterways : ["Kaibolovo", "Tesovo", "Sablia"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Tesovo" : { trackways: ["Ingria", "Novgorod"], waterways : ["Zheltsy"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Novgorod" : { trackways: ["Tesovo", "Sablia"], waterways : ["Volkhov", "Shelon River", "Rusa"], teuton: false, seats: ["Aleksander", "Andrey", "Domash"], commandery: false, stronghold: true, port: false},
            "Uzmen" : { trackways: ["Ugaunia"], waterways : ["Dorpat", "Narwia", "Gdov", "Zhelcha River", "Pskov"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Zhelcha River" : { trackways: ["Plyussa River", "Pskov"], waterways : ["Uzmen"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Sablia" : { trackways: ["Novgorod", "Shelon River"], waterways : ["Zheltsy"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Pskov" : { trackways: ["Izborsk", "Zhelcha River", "Dubrovno"], waterways : ["Uzmen", "Ostrov"], teuton: false, seats: ["Yaroslav", "Gavrilo"], commandery: false, stronghold: true, port: false},
            "Dubrovno" : { trackways: ["Pskov", "Porkhov"], waterways : ["Shelon River"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Shelon River" : { trackways: ["Sablia"], waterways : ["Dubrovno", "Porkhov", "Novgorod", "Rusa"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Rusa" : { trackways: [], waterways : ["Shelon River", "Novgorod", "Lovat"], teuton: false, seats: ["Aleksander, Andrey"], commandery: false, stronghold: true, port: false},
            "Izborsk" : { trackways: ["Ugaunia", "Kirrumpah", "Lettgalia", "Pskov"], waterways : [], teuton: false, seats: [], commandery: false, stronghold: true, port: false},
            "Porkhov" : { trackways: ["Dubrovno", "Sorot River"], waterways : ["Shelon River"], teuton: false, seats: [], commandery: false, stronghold: true, port: false},
            "Lovat" : { trackways: [], waterways : ["Rusa", "Velikiye Luki"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Ostrov" : { trackways: ["Lettgalia"], waterways : ["Pskov", "Velikaya River"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Sorot River" : { trackways: ["Porkhov"], waterways : ["Velikaya River"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Velikaya River" : { trackways: ["Velikiye Luki"], waterways : ["Ostrov", "Sorot River"], teuton: false, seats: [], commandery: false, stronghold: false, port: false},
            "Velikiye Luki" : { trackways: ["Velikaya River"], waterways : ["Lovat"], teuton: false, seats: [], commandery: false, stronghold: true, port: false},
         }
    
        let bonus_friendly_locales = []; // locales that are besieged by a friendly or conquered by a friendly, can trace supply
        let bonus_enemy_locales = []; // locales with an enemy lord or conquered by an enemy, can't trace supply
    
        let carts;
        let boats;
        let sleds;
        let ships;
        let start; // start locale, string
        let teuton; // whether playing the teutons instead of russians, bool
        let bonus = false; // whether the bonus card is active, bool
    
        // TODO
        // I believe the doubleseat/ship needs to be reworked into an attribute of the path rather than a class of path, otherwise we get basically duplicate paths
    
    
    
    
        // if initial is true, returns a tuple containing:
        // an array of paths needed to reach the maximum provender per action
        // an int representing maximum provender per action
    
        // if initial is false, instead returns an array of paths that end at a possible supply source
        function get_supply(carts = carts, boats = boats, sleds = sleds, ships = ships, start = start, 
        teuton = teuton, lord = lord, bonus = bonus, already_visited = [], initial = true){
            let paths = []
            if(!blocked(start, teuton)){
                already_visited.push(start)
                
                if(carts > 0 || sleds > 0){
                    for (locale of map[start].trackways){
                        if(!(already_visited.includes(locale))){
                            let new_paths = get_supply((carts > 0 ? carts -1 : 0), boats, (sleds > 0 ? sleds - 1 : 0), ships, locale, teuton, lord, bonus, already_visited, false)
                            for (path of new_paths){
                                paths.push([start].concat(path))
                            }
                        }
                    }
                }
                if(boats > 0 || sleds > 0){
                    for (locale of map[start].waterways){
                        if(!(already_visited.includes(locale))){
                            let new_paths = get_supply(carts, (boats > 0 ? boats - 1 : 0), (sleds > 0 ? sleds - 1 : 0), ships, locale, teuton, lord, bonus, already_visited, false)
                            for (path of new_paths){
                                paths.push([start].concat(path))
                            }
                        }
                    }
                }
                if(supportsShips(start, teuton)){
                    paths.push([start])
                }
            }
            if(initial){
               paths.sort((a,b) => a.length - b.length)
               paths = paths.map(function(path){
                   let seats = 0
                   for (locale of path){
                        seats += seatsFor(locale, lord, teuton, bonus)
                   }
                   return {
                    "seats": Math.min(seats, 2),
                    "supportsShips": path.some(locale => supportsShips(locale, teuton)),
                    "route": path
                   }
                })
                let seat_paths = paths.filter(path => path.seats >= 1)
                let double_seat_paths = paths.filter(path => path.seats >= 2)
                let ship_paths = paths.filter(path => path.supportsShips)
                let double_seat_ship_paths = double_seat_paths.filter(path => ship_paths.includes(path))
                let seat_ship_paths = seat_paths.filter(path => ship_paths.includes(path))
                if(double_seat_ship_paths.length > 0){
                    return [[double_seat_ship_paths[0].route], 2 + Math.min(ships, 2)]
                }
                if(double_seat_paths.length > 0){
                    if(ship_paths.length > 0){    
                        return[[double_seat_paths[0].route, ship_paths[0].route], 2 + Math.min(ships,2)]
                    }else{                    
                        return [[double_seat_paths[0].route], 2]
                    }
                }

                if(seat_ship_paths.length > 0){
                    let main = seat_ship_paths[0]
                    let others = seat_paths.filter(path => path.route[path.length-1] !== main.route[main.length-1])
                    if(others.length > 0){    
                        return [[main.route, others[0].route], 2 + Math.min(ships, 2)]
                    }else{                    
                        return [[main].route, 1 + Math.min(ships, 2)]
                    }
                }
                if(seat_paths.length > 0){
                    let ret = seat_paths.slice(0, 2).map(path => path.route)
                    let prov = ret.length
                    if(ship_paths.length > 0){
                        ret.push(ship_paths[0].route)
                        return [ret, prov + Math.min(ships, 2)]
                    }else{
                        return[ret, prov]
                    }
                }
                return [[], 0]
            }else{
                return paths
            }
        }
    
        function blocked(locale, teuton){
            if(bonus_friendly_locales.includes(locale)){
                return false
            }else if(bonus_enemy_locales.includes(locale)){
                return true
            }else{
                return (map[locale].stronghold && (map[locale].teuton != teuton))
            }
        }
    
        function supportsShips(locale, teuton){
            return (map[locale].port && teuton) || (locale === "Novgorod" && !teuton)
        }

        function seatsFor(locale, lord, teuton, bonus){
            return (map[locale].seats.includes(lord) ? 1 : 0) + ((bonus && ((map[locale].commandery && teuton) || (bonus && locale === "Novgorod" && !teuton)) ? 1 : 0)) 
        }
    
        let ret = get_supply(3, 0, 0, 1, "Wierland", true, "Knud&Abel", false)
        console.log(ret)
        document.getElementById('demo').innerHTML = ret
    </script>
</body>